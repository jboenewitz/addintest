{% load i18n static compress %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Forward Email Add-in</title>
    <script src="{% static 'framework/jquery/jquery-3.6.0.min.js' %}" type="text/javascript"></script>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js" type="text/javascript"></script>
</head>
<body>
    <h1>Forward Email v13</h1>
    <button id="loginButton">Login</button>
    <button id="forwardButton" disabled>Forward Email</button>
<script type="text/javascript">
    Office.initialize = function () {
    document.getElementById("forwardButton").onclick = function () {
        // Initialize the MSAL client
        const msalConfig = {
            auth: {
                clientId: 'xYC9XDGKS7QCzcgOpz2qn34EPQtkZheeBHg06eer',
                authority: 'https://login.microsoftonline.com/common',
                redirectUri: 'https://localhost:3000/redirect',
                scopes: ['Mail.ReadWrite']
            },
            cache: {
                cacheLocation: 'localStorage'
            }
            clientSecret: 'vZErfZv9m9N5XcncArSIkQYr9BXfPS4JerbMuID1cS9ZMN9szZwwgh9AonxNWV8m7MvlQbW65Ylnixv0kr7lZoFPWKXlmBuxzc0cEUCp6FYgfLwD4C982RIUVeaI6Muo'
        };
        const msalInstance = new msal.ConfidentialClientApplication(msalConfig);

        // Get the email item
        var item = Office.context.mailbox.item;

        // Get the email metadata
        var subject = item.subject;
        var sender = item.sender.emailAddress;

        // Get the email content
        item.body.getAsync('text', function(result){
            var body = result.value;

            // Create the HTML content for the email
            var htmlContent = "<html><head><title>" + subject + "</title></head><body><h1>" + subject + "</h1><p>From: " + sender + "</p><div>" + body + "</div></body></html>";

            // Authenticate using MSAL
            msalInstance.acquireTokenByClientCredential({
                scopes: msalConfig.auth.scopes,
                authority: msalConfig.auth.authority
            }).then(function (authResponse) {
                // Store the access token in roaming settings
                Office.context.roamingSettings.set('accessToken', authResponse.accessToken);
                Office.context.roamingSettings.saveAsync();

                // Make the CORS request
                $.ajax({
                    url: "{% url 'store:contact_formular_api' %}",
                    type: "POST",
                    dataType: "json",
                    contentType: "application/x-www-form-urlencoded",
                    headers: {
                        Authorization: "Bearer " + authResponse.accessToken
                    },
                    data: { html_content: htmlContent },
                    success: function(response) {
                        console.log("Email forwarded successfully");
                    },
                    error: function(xhr, status, error) {
                        console.log("Failed to forward email: " + error);
                    }
                });
            }).catch(function (error) {
                console.log("Authentication failed: " + error);
            });
        });
    };
};

</script>

</body>
</html>
